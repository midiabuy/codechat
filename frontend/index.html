<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
</head>

<body>
  <h1>Websocket</h1>

  <form action="" id="instance-form">
    <label for="input-instance">Instance Name</label>
    <input type="text" id="input-instance" />
    <button type="submit">Create Instance</button>
  </form>

  <div>
    <img src="" alt="" id="qrcode" />
  </div>

  <script>
    const url = "http://localhost:8084/instance/create"
    const token = "zYzP7ocstxh3Sscefew4FZTCu4ehnM8v4hu"

    async function createInstance(instanceName) {
      await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
          "apikey": token
        },
        body: JSON.stringify({ "instanceName": instanceName }),
      });

      await fetch(`http://localhost:8084/instance/connect/${instanceName}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
          "apikey": token
        },
      }).then(response => response.json())
        .then(data => {
          document.getElementById('qrcode').src = data.base64;
        });
    }

    async function contactCards(instanceName) {

      const getPicture = async (jid) => {
        try {
          const request = await fetch(`http://localhost:8084/chat/fetchProfilePictureUrl/${instanceName}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`,
              "apikey": token
            },
            body: JSON.stringify({
              "number": jid,
            })
          });

          if (!request.ok) {
            // Handle the error if the request was not successful
            throw new Error(`Error: ${request.status} - ${request.statusText}`);
          }

          const response = await request.json();

          if (response && response.profilePictureUrl) {
            return response.profilePictureUrl;
          }

          return "";

        } catch (error) {
          console.error("Error fetching profile picture:", error.message);
          return "";
        }
      };

      const messageResponse = await fetch(`http://localhost:8084/chat/findMessages/${instanceName}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
          "apikey": token
        },
        body: JSON.stringify({
          "page": 1,
        })
      });

      const messageData = await messageResponse.json();
      const records = messageData.messages.records;

      const contacts = await Promise.all(records.map(async (item) => {
        const picture = await getPicture(item.keyRemoteJid);

        return {
          jid: item.keyRemoteJid,
          name: item.pushName,
          picture: picture,
          messages: [{ content: item.content }]
        };
      }));

      console.log(contacts.length);
      console.log(contacts);

    }

    contactCards("Lucas")

    document.getElementById("instance-form").addEventListener("submit", (event) => {
      event.preventDefault();
      const instanceName = document.getElementById("input-instance").value;
      createInstance(instanceName);
    })
  </script>

  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <script>
    const socket = io("ws://127.0.0.1:8084", {
      transports: ["websocket"],
      auth: {
        serverOffset: 0,
      },
    });
    // let socket = new WebSocket("ws://127.0.0.1:3001");
    console.log("Attempting Connection...");

    socket.on("connect", () => {
      console.log("connected");
    });

    // socket.on("onmessage", (message, offset) => {
    //   console.log(message);
    // });

    socket.on("oncontacts", (contact) => {
      console.log(contact);
    });

    socket.on("connection_error", (e) => {
      console.log(e);
    });

    socket.on("disconnect", (e) => {
      console.log(e);
      socket.connect();
    });

    // socket.onopen = () => {
    //     console.log("Successfully Connected");
    // };

    // socket.onmessage = event => {
    //     console.log("Received message:", event.data);
    //     displayMessage(event.data);
    // };

    // socket.onclose = event => {
    //     console.log("Socket Closed Connection: ", event);
    //     socket.send("Client Closed!");
    // };

    // socket.onerror = error => {
    //     console.log("Socket Error: ", error);
    // };

    // function displayMessage(message) {
    //     console.log(message);
    // };
  </script>
</body>

</html>